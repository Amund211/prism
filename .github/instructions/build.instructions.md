---
applyTo:
  - "pyinstaller/**"
  - "add_version_to_icon.py"
  - "**/*.spec"
  - ".github/workflows/testing.yml"
---

# Build and Packaging Instructions for Prism

## Build System Overview
Prism uses PyInstaller to create standalone executables for Windows, macOS, and Linux. The build process is automated through GitHub Actions but can be run locally.

## Local Build Process

### Prerequisites for Coding Agents
**Note**: As a coding agent, you typically don't need to build binaries locally. If tests and linting pass, the PyInstaller build will likely succeed in CI. This section is provided for reference but building is generally unnecessary.

Dependencies are already installed in your global environment. If you do need to build locally:

### Build Steps (EXACT ORDER)

1. **Create versioned icon** (REQUIRED first):
```bash
python add_version_to_icon.py
# Creates pyinstaller/who_with_version.ico with version overlay
```

2. **Build executable** (Linux only):
```bash
# First, get the current version from the source
CURRENT_VERSION=$(python -c "from prism import VERSION_STRING; print(VERSION_STRING)")

# Linux build
pyinstaller prism_overlay.py --noconfirm --onefile --icon=pyinstaller/who_with_version.ico --name "prism-${CURRENT_VERSION}" --additional-hooks-dir=pyinstaller
```

## Build Artifacts
- **Linux**: `dist/prism-${VERSION}` (executable binary)

## PyInstaller Configuration

### Hook Files
- `pyinstaller/hook-pynput.py`: Custom hook for pynput library
- Hooks handle platform-specific imports and hidden dependencies

### Icon Handling
- Base icon: `pyinstaller/who.ico`
- Versioned icon: Generated by `add_version_to_icon.py`
- Process: Overlays version string on base icon using PIL

### Build Arguments Explained
- `--onefile`: Creates single executable (vs directory)
- `--noconfirm`: Overwrites existing build without prompting
- `--icon`: Sets application icon
- `--additional-hooks-dir`: Uses custom hooks directory
- `--hide-console=minimize-early`: Windows-only, minimizes console window
- `--target-architecture universal2`: macOS-only, Intel + Apple Silicon
- `--windowed`: macOS-only, creates .app bundle instead of console app

## CI/CD Build Process
GitHub Actions (`.github/workflows/testing.yml`) automatically:

1. **Multi-platform builds**: Ubuntu, Windows, macOS
2. **Dependency installation**: Platform-specific requirements
3. **Quality checks**: Tests, type checking, linting
4. **Icon generation**: Version overlay on icon
5. **PyInstaller builds**: Platform-specific executables
6. **Artifact upload**: Stores build results

### Build Matrix
- **OS**: ubuntu-latest, windows-latest, macOS-13
- **Python**: 3.13
- **Architectures**: Native + Universal2 (macOS)

## Build Timing
- **Linux**: ~3-5 minutes
- **Windows**: ~4-6 minutes  
- **macOS**: ~5-8 minutes (includes DMG creation)

## Troubleshooting Build Issues

### Common Problems:
1. **Missing dependencies**: Ensure all requirements installed
2. **Icon generation fails**: Check PIL/Pillow installation
3. **Import errors**: Run `pip install --no-deps -e .`
4. **Platform-specific failures**: Check platform requirements
5. **PyInstaller hook issues**: Verify hook files exist

### Debug Commands:
```bash
# Verbose PyInstaller output
pyinstaller --log-level DEBUG prism_overlay.py ...

# Check import tree
pyi-makespec --debug prism_overlay.py
```

## Version Management
Version string defined in `src/prism/__init__.py`:
```python
VERSION_STRING = "v1.9.1-dev"
```

Update this file to change version in all build artifacts.

## Dependency Notes
- **pip version**: CI pins to <=25.0 due to pip-tools compatibility
- **Platform differences**: Requirements files vary significantly between platforms
- **SSL certificates**: Builds include system vs included certificate handling