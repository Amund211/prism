---
applyTo:
  - "pyinstaller/**"
  - "add_version_to_icon.py"
  - "**/*.spec"
  - ".github/workflows/testing.yml"
---

# Build and Packaging Instructions for Prism

## Build System Overview
Prism uses PyInstaller to create standalone executables for Windows, macOS, and Linux. The build process is automated through GitHub Actions but can be run locally.

## Local Build Process

### Prerequisites (CRITICAL)
```bash
# MUST have virtual environment activated
source venv/bin/activate  # Linux/macOS
# OR venv\Scripts\activate.bat  # Windows

# MUST have platform-specific dependencies installed
pip install -r requirements/linux.txt -r requirements/linux-dev.txt     # Linux
pip install -r requirements/windows.txt -r requirements/windows-dev.txt # Windows  
pip install -r requirements/mac.txt -r requirements/mac-dev.txt         # macOS

# MUST install package in development mode
pip install --no-deps -e .
```

### Build Steps (EXACT ORDER)

1. **Create versioned icon** (REQUIRED first):
```bash
python add_version_to_icon.py
# Creates pyinstaller/who_with_version.ico with version overlay
```

2. **Build executable**:
```bash
# Linux build
pyinstaller prism_overlay.py --noconfirm --onefile --icon=pyinstaller/who_with_version.ico --name "prism-v1.9.1-dev" --additional-hooks-dir=pyinstaller

# Windows build
pyinstaller prism_overlay.py --noconfirm --onefile --icon=pyinstaller/who_with_version.ico --name "prism-v1.9.1-dev" --additional-hooks-dir=pyinstaller --hide-console=minimize-early

# macOS build (Universal2 for Intel + Apple Silicon)
pyinstaller prism_overlay.py --noconfirm --onefile --icon=pyinstaller/who_with_version.ico --name "prism-v1.9.1-dev" --additional-hooks-dir=pyinstaller --target-architecture universal2 --windowed
```

### macOS-Specific: DMG Creation
```bash
# Convert icon to .icns format
brew install imagemagick
magick pyinstaller/who_with_version.ico pyinstaller/who_with_version.icns

# Create DMG installer
brew install create-dmg
mkdir -p 'dist/app'
mv "dist/prism-v1.9.1-dev.app" "dist/app"

create-dmg \
  --volname "Prism v1.9.1-dev installer" \
  --volicon 'pyinstaller/who_with_version.icns' \
  --window-pos 200 120 \
  --window-size 600 300 \
  --icon-size 100 \
  --icon "prism-v1.9.1-dev.app" 175 120 \
  --hide-extension "prism-v1.9.1-dev.app" \
  --app-drop-link 425 120 \
  "prism-v1.9.1-dev.dmg" \
  "dist/app/"
```

## Build Artifacts
- **Linux**: `dist/prism-v1.9.1-dev` (executable binary)
- **Windows**: `dist/prism-v1.9.1-dev.exe` (executable)
- **macOS**: `prism-v1.9.1-dev.dmg` (disk image with .app bundle)

## PyInstaller Configuration

### Hook Files
- `pyinstaller/hook-pynput.py`: Custom hook for pynput library
- Hooks handle platform-specific imports and hidden dependencies

### Icon Handling
- Base icon: `pyinstaller/who.ico`
- Versioned icon: Generated by `add_version_to_icon.py`
- Process: Overlays version string on base icon using PIL

### Build Arguments Explained
- `--onefile`: Creates single executable (vs directory)
- `--noconfirm`: Overwrites existing build without prompting
- `--icon`: Sets application icon
- `--additional-hooks-dir`: Uses custom hooks directory
- `--hide-console=minimize-early`: Windows-only, minimizes console window
- `--target-architecture universal2`: macOS-only, Intel + Apple Silicon
- `--windowed`: macOS-only, creates .app bundle instead of console app

## Build Validation

### Test Built Executable
```bash
# Check version info
dist/prism-v1.9.1-dev --help

# Test SSL functionality (requires test environment)
dist/prism-v1.9.1-dev --test-ssl --settings=test_settings.toml --logfile=latest.log
```

## CI/CD Build Process
GitHub Actions (`.github/workflows/testing.yml`) automatically:

1. **Multi-platform builds**: Ubuntu, Windows, macOS
2. **Dependency installation**: Platform-specific requirements
3. **Quality checks**: Tests, type checking, linting
4. **Icon generation**: Version overlay on icon
5. **PyInstaller builds**: Platform-specific executables
6. **Artifact upload**: Stores build results

### Build Matrix
- **OS**: ubuntu-latest, windows-latest, macOS-13
- **Python**: 3.13
- **Architectures**: Native + Universal2 (macOS)

## Build Timing
- **Linux**: ~3-5 minutes
- **Windows**: ~4-6 minutes  
- **macOS**: ~5-8 minutes (includes DMG creation)

## Troubleshooting Build Issues

### Common Problems:
1. **Missing dependencies**: Ensure all requirements installed
2. **Icon generation fails**: Check PIL/Pillow installation
3. **Import errors**: Run `pip install --no-deps -e .`
4. **Platform-specific failures**: Check platform requirements
5. **PyInstaller hook issues**: Verify hook files exist

### Debug Commands:
```bash
# Verbose PyInstaller output
pyinstaller --log-level DEBUG prism_overlay.py ...

# Check import tree
pyi-makespec --debug prism_overlay.py
```

## Version Management
Version string defined in `src/prism/__init__.py`:
```python
VERSION_STRING = "v1.9.1-dev"
```

Update this file to change version in all build artifacts.

## Dependency Notes
- **pip version**: CI pins to <=25.0 due to pip-tools compatibility
- **Platform differences**: Requirements files vary significantly between platforms
- **SSL certificates**: Builds include system vs included certificate handling